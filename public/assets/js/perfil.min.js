function initializeProfileManagement(){let a=document.getElementById("profile-pic-preview"),n=document.getElementById("profile-pic-upload");var e=document.getElementById("upload-profile-pic"),t=document.getElementById("change-password-btn"),o=document.getElementById("add-admin-btn"),d=document.getElementById("add-email-btn");let l=document.getElementById("new-admin-name"),i=document.getElementById("new-admin-email"),r=document.getElementById("new-admin-senha");var m=document.getElementById("saveProfileBtn");let s=document.getElementById("admins-list"),c=document.getElementById("emails-list"),u=new bootstrap.Modal(document.getElementById("saveProfileModal")),p=document.getElementById("modalMessage"),v=document.querySelector('input[name="_csrf_token"]')?.value;v||console.error("Token CSRF não encontrado. Verifique o HTML."),e.addEventListener("click",()=>n.click()),n.addEventListener("change",()=>{var e,t=n.files[0];t&&t.type.startsWith("image/")&&((e=new FileReader).onload=e=>a.src=e.target.result,e.readAsDataURL(t))}),t.addEventListener("click",()=>{var e=document.getElementById("current-password").value,t=document.getElementById("new-password").value;t!==document.getElementById("confirm-password").value?alert("As senhas não coincidem!"):(console.log("Alterando senha:",{currentPassword:e,newPassword:t}),alert("Senha alterada com sucesso! (Simulação)"))}),o.addEventListener("click",()=>{var e=l.value.trim(),t=i.value.trim(),a=r.value.trim();e&&t?(e={nome:e,email:t,senha:a||void 0},(t=document.createElement("div")).className="admin-item",t.dataset.id=Date.now(),t.innerHTML=`
                <span>${e.nome} (${e.email})</span>
                <input type="password" class="form-control admin-password" placeholder="Senha" value="${e.senha||""}">
                <button class="remove-btn btn btn-danger">Remover</button>
            `,s.appendChild(t),(a=s.querySelector("div:not(.admin-item)"))&&a.remove(),l.value="",i.value="",r.value=""):alert("Preencha nome e e-mail.")}),d.addEventListener("click",()=>{var e,t,a=document.getElementById("new-email").value;a?(t=Date.now(),(e=document.createElement("div")).className="email-item",e.dataset.id=t,e.innerHTML=`<span>${a}</span><button class="remove-btn">Remover</button>`,c.appendChild(e),(t=c.querySelector("div:not(.email-item)"))&&t.remove(),document.getElementById("new-email").value=""):alert("Preencha o e-mail!")}),[s,c].forEach(e=>{e.addEventListener("click",e=>{e.target.classList.contains("remove-btn")&&e.target.parentElement.remove()})}),m.addEventListener("click",()=>{var e={nome_exibicao:document.getElementById("display-name").value,admin_name:document.getElementById("admin-name").value,admin_email:document.getElementById("admin-email").value,foto_perfil:document.getElementById("profile-pic-preview").src,admins:Array.from(s.children).filter(e=>e.classList.contains("admin-item")).map(e=>{var t,a=e.querySelector("span"),n=e.querySelector(".admin-password");return a&&n?([a,t]=a.textContent.split(" ("),t=t?t.replace(")",""):"",{id:e.dataset.id,nome:a,email:t,senha:n.value||void 0}):(console.warn("Span ou input de senha não encontrado:",e),null)}).filter(e=>null!==e),emails_empresa:Array.from(c.children).filter(e=>e.classList.contains("email-item")).map(e=>{var t=e.querySelector("span");return t?{id:e.dataset.id,email:t.textContent.trim()}:(console.warn("Span não encontrado em um item de email:",e),null)}).filter(e=>null!==e)};p.textContent="Salvando dados...",u.show(),fetch("/admin/profile/updateProfile",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":v,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({...e,_csrf_token:v})}).then(t=>t.ok?t.json():t.text().then(e=>{throw new Error(`Erro HTTP ${t.status}: `+e)})).then(e=>{console.log("Resposta do backend:",e),e.success?(p.textContent=e.message||"Perfil salvo com sucesso!",p.style.color="#e0e0e0",c.innerHTML="",e.data.emails_empresa&&0<e.data.emails_empresa.length?e.data.emails_empresa.forEach(e=>{var t=document.createElement("div");t.className="email-item",t.dataset.id=e.id,t.innerHTML=`<span>${e.email}</span><button class="remove-btn">Remover</button>`,c.appendChild(t)}):c.innerHTML="<div>Não há e-mails cadastrados</div>",s.innerHTML="",e.data.admins&&0<e.data.admins.length?e.data.admins.forEach(e=>{var t=document.createElement("div");t.className="admin-item",t.dataset.id=e.id,t.innerHTML=`
                            <span>${e.nome} (${e.email})</span>
                            <small>(Criado por ID: ${e.created_by})</small>
                            <button class="remove-btn btn btn-danger">Remover</button>
                        `,s.appendChild(t)}):s.innerHTML="<div>Não há administradores cadastrados para esse perfil</div>"):(p.textContent=e.message||"Erro ao salvar o perfil.",p.style.color="#ff4d4d"),setTimeout(()=>u.hide(),2e3)}).catch(e=>{p.textContent="Erro na requisição: "+e.message,p.style.color="#ff4d4d",console.error("Erro detalhado:",e),setTimeout(()=>u.hide(),2e3)}),console.log("Perfil salvo:",e)})}console.log("Script gerenciar-perfil.js carregado com sucesso!"),initializeProfileManagement();